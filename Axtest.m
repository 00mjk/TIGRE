%% How to use Ax with CUDA:
% 
%
% Attention: The code has been written for a NVIDIA Tesla k40 graphic card,
% and most likely need to be tunned if it is wanted to use with another a
% different one. 
%
%
% This code solves geometrically the A*x of a linear system of equations
% for the Cone Beam Computed Tomography geometry. In other words, it
% computes a projection with a given image. It can be used for both forward
% projection (simulating the measured 2D projections) and for iterative
% inverse solving of the image, where in many cases (as in SART algorithm)
% the A*x term has to be computed several times. The benefit is that there
% is no need of actually computing the matrix A.
%
% The code makes use of graphic cards hardware implemented texture memory 
% and the multy CPU arquitechture of modern GPUs to simultaneously compute
% the projection in each detector pixel.
%
%
% A single call to Ax will compute a single projection (as for 05/08/2015).
% Detector array is plane.
%
% INPUT ARGUMETS: 
%       projection=Ax(image, geometry)
%  
% IMAGE: a 3D image of the current solution.
% GEOMETRY: an structure describing the geometry of the CBCT, containing:
%           -nVoxel:        3x1 matrix of number of voxels in the image
%           -sVoxel:        3x1 matrix with the total size in mm of the image
%           -dVoxel:        3x1 matrix with the size of each of the voxels in mm
%           -nDetector:     2x1 matrix of number of voxels in the detector plane
%           -sDetector:     2x1 matrix with the total size in mm of the detector
%           -dDetector:     2x1 matrix with the size of each of the pixels in the detector in mm
%           -DSD:           1x1 scalar value. Distance Source Detector, in mm  
%           -DSO:           1x1 scalar value. Distance Source Origin.
%           -offOrigin:     3x1 matrix with the offset in mm of the centre of the image from the origin.
%           -offDetector:   2x1 matrix with the offset in mm of the centre of the detector from the x axis
% ALPHA: the angle in radians of the projection
% 

%%  GEOMETRY DEFINITION
%                 
%                  Detector plane, behind
%              |-----------------------------| 
%              |                             | 
%              |                             | 
%              |                             | 
%  Centered    |                             | 
%    at O      |      +--------+             |
%              |     /        /|             |
%     A Z      |    /        / |*D           |
%     |        |   +--------+  |             |
%     |        |   |        |  |             |
%     |        |   |     *O |  +             |
%     *--->y   |   |        | /              |
%    /         |   |        |/               |
%   V X        |   +--------+                |
%              |-----------------------------|
%     
%            *S
%  
%  
%  
%  
%  
%  
%% Example of use
testtime=0;



Geometry.nVoxel=[128;128;128];
Geometry.sVoxel=[460;460;460];

Geometry.dVoxel=Geometry.sVoxel./Geometry.nVoxel;

Geometry.nDetector=[256; 200];
Geometry.sDetector=[1024; 800];
Geometry.dDetector=Geometry.sDetector./Geometry.nDetector;

Geometry.DSD = 1500;   
Geometry.DSO = 1100;

Geometry.offOrigin=[0; 0; 0];
Geometry.offDetector=[0; 0];

load img128
% ParamSetting;
img1=ones(Geometry.nVoxel')*2;
img1(10:20,10:20,10:20)=10;
img1(80:120,80:120,80:120)=0;
% img1(1:128,1,1)=1:128;
% img1(:,128,:)=img(:,64,:);
img=img1;
alpha=[0:220]*pi/180+pi/2;


if testtime
    tic 
    b=Ax(img,Geometry,alpha);
    mine=toc;
    tic
    proj = CTprojection(img,param);
    gpuKorea=toc;
    param.gpu=0;
%     tic
%    proj = CTprojection(img,param);
%     cpuKorea=toc;
    break;
end
% alpha=0;
% alpha=pi/4;
% alpha=30 *pi/180;
tic
b=Ax(img,Geometry,alpha);
toc
% break;
for i=1:numel(alpha)
    image=reshape(b(:,i),Geometry.nDetector(1),Geometry.nDetector(2));
    figure(1); imagesc(image'); axis image; axis equal; colormap gray; colorbar;
    title(['Degree : ',num2str(alpha(i)*180/pi)]);
    pause(0.01);
end

break
%% plot this!
angle=40;
angle=angle+1;
load proj.mat
image=reshape(b(:,angle),Geometry.nDetector(1),Geometry.nDetector(2));
image=image'/max(image(:));
subplot(1,3,1)
imshow(image,[])


subplot(1,3,2)
imagekorea=fliplr(imrotate( squeeze(proj(:,:,angle)),90));
imagekorea=imagekorea/max(imagekorea(:));
imshow(imagekorea,[])


subplot(1,3,3)
imshow(abs(image-imagekorea),[]);%colorbar;
figure
plot(imagekorea(100,:));hold on;plot(image(100,:));
break;
%% %%
% S=[64.556522 -47.304348 175.860870 66.498966 -47.297108 175.860870 68.440648 -47.255967 175.860870 70.380979 -47.180935 175.860870 72.319365 -47.072037 175.860870 74.255217 -46.929305 175.860870 76.187945 -46.752783 175.860870 78.116961 -46.542525 175.860870 80.041677 -46.298594 175.860870 81.961506 -46.021066 175.860870 83.875864 -45.710024 175.860870 85.784168 -45.365563 175.860870 87.685836 -44.987788 175.860870 89.580289 -44.576815 175.860870 91.466949 -44.132768 175.860870 93.345244 -43.655783 175.860870 95.214599 -43.146004 175.860870 97.074446 -42.603588 175.860870 98.924219 -42.028700 175.860870 100.763353 -41.421514 175.860870 102.591288 -40.782216 175.860870 104.407469 -40.111000 175.860870 106.211341 -39.408071 175.860870 108.002354 -38.673643 175.860870 109.779965 -37.907939 175.860870 111.543630 -37.111193 175.860870 113.292813 -36.283648 175.860870 115.026981 -35.425556 175.860870 116.745606 -34.537177 175.860870 118.448163 -33.618783 175.860870 120.134136 -32.670654 175.860870 121.803009 -31.693077 175.860870 123.454275 -30.686352 175.860870 125.087431 -29.650784 175.860870 126.701979 -28.586689 175.860870 128.297427 -27.494392 175.860870 129.873290 -26.374224 175.860870 131.429087 -25.226528 175.860870 132.964344 -24.051652 175.860870 134.478594 -22.849955 175.860870 135.971376 -21.621802 175.860870 137.442235 -20.367569 175.860870 138.890722 -19.087636 175.860870 140.316397 -17.782394 175.860870 141.718825 -16.452240 175.860870 143.097579 -15.097579 175.860870 144.452240 -13.718825 175.860870 145.782394 -12.316397 175.860870 147.087636 -10.890722 175.860870 148.367569 -9.442235 175.860870 149.621802 -7.971376 175.860870 150.849955 -6.478594 175.860870 152.051652 -4.964344 175.860870 153.226528 -3.429087 175.860870 154.374224 -1.873290 175.860870 155.494392 -0.297427 175.860870 156.586689 1.298021 175.860870 157.650784 2.912569 175.860870 158.686352 4.545725 175.860870 159.693077 6.196991 175.860870 160.670654 7.865864 175.860870 161.618783 9.551837 175.860870 162.537177 11.254394 175.860870 163.425556 12.973019 175.860870 164.283648 14.707187 175.860870 165.111193 16.456370 175.860870 165.907939 18.220035 175.860870 166.673643 19.997646 175.860870 167.408071 21.788659 175.860870 168.111000 23.592531 175.860870 168.782216 25.408712 175.860870 169.421514 27.236647 175.860870 170.028700 29.075781 175.860870 170.603588 30.925554 175.860870 171.146004 32.785401 175.860870 171.655783 34.654756 175.860870 172.132768 36.533051 175.860870 172.576815 38.419711 175.860870 172.987788 40.314164 175.860870 173.365563 42.215832 175.860870 173.710024 44.124136 175.860870 174.021066 46.038494 175.860870 174.298594 47.958323 175.860870 174.542525 49.883039 175.860870 174.752783 51.812055 175.860870 174.929305 53.744783 175.860870 175.072037 55.680635 175.860870 175.180935 57.619021 175.860870 175.255967 59.559352 175.860870 175.297108 61.501034 175.860870 175.304348 63.443478 175.860870 175.277683 65.386092 175.860870 175.217122 67.328283 175.860870 175.122683 69.269460 175.860870 174.994395 71.209033 175.860870 174.832297 73.146409 175.860870 174.636439 75.080999 175.860870 174.406879 77.012214 175.860870 174.143689 78.939466 175.860870 173.846947 80.862166 175.860870 173.516746 82.779730 175.860870 173.153184 84.691574 175.860870 172.756373 86.597115 175.860870 172.326434 88.495772 175.860870 171.863498 90.386968 175.860870 171.367706 92.270126 175.860870 170.839208 94.144673 175.860870 170.278166 96.010038 175.860870 169.684751 97.865651 175.860870 169.059143 99.710949 175.860870 168.401533 101.545370 175.860870 167.712121 103.368353 175.860870 166.991118 105.179345 175.860870 166.238742 106.977792 175.860870 165.455224 108.763149 175.860870 164.640801 110.534870 175.860870 163.795722 112.292416 175.860870 162.920245 114.035252 175.860870 162.014635 115.762847 175.860870 161.079169 117.474674 175.860870 160.114132 119.170212 175.860870 159.119817 120.848945 175.860870 158.096529 122.510361 175.860870 157.044577 124.153954 175.860870 155.964283 125.779224 175.860870 154.855976 127.385675 175.860870 153.719994 128.972819 175.860870 152.556681 130.540171 175.860870 151.366394 132.087254 175.860870 150.149494 133.613597 175.860870 148.906352 135.118735 175.860870 147.637347 136.602210 175.860870 146.342864 138.063570 175.860870 145.023300 139.502368 175.860870 143.679055 140.918169 175.860870 142.310539 142.310539 175.860870 140.918169 143.679055 175.860870 139.502368 145.023300 175.860870 138.063570 146.342864 175.860870 136.602210 147.637347 175.860870 135.118735 148.906352 175.860870 133.613597 150.149494 175.860870 132.087254 151.366394 175.860870 130.540171 152.556681 175.860870 128.972819 153.719994 175.860870 127.385675 154.855976 175.860870 125.779224 155.964283 175.860870 124.153954 157.044577 175.860870 122.510361 158.096529 175.860870 120.848945 159.119817 175.860870 119.170212 160.114132 175.860870 117.474674 161.079169 175.860870 115.762847 162.014635 175.860870 114.035252 162.920245 175.860870 112.292416 163.795722 175.860870 110.534870 164.640801 175.860870 108.763149 165.455224 175.860870 106.977792 166.238742 175.860870 105.179345 166.991118 175.860870 103.368353 167.712121 175.860870 101.545370 168.401533 175.860870 99.710949 169.059143 175.860870 97.865651 169.684751 175.860870 96.010038 170.278166 175.860870 94.144673 170.839208 175.860870 92.270126 171.367706 175.860870 90.386968 171.863498 175.860870 88.495772 172.326434 175.860870 86.597115 172.756373 175.860870 84.691574 173.153184 175.860870 82.779730 173.516746 175.860870 80.862166 173.846947 175.860870 78.939466 174.143689 175.860870 77.012214 174.406879 175.860870 75.080999 174.636439 175.860870 73.146409 174.832297 175.860870 71.209033 174.994395 175.860870 69.269460 175.122683 175.860870 67.328283 175.217122 175.860870 65.386092 175.277683 175.860870 63.443478 175.304348 175.860870 61.501034 175.297108 175.860870 59.559352 175.255967 175.860870 57.619021 175.180935 175.860870 55.680635 175.072037 175.860870 53.744783 174.929305 175.860870 51.812055 174.752783 175.860870 49.883039 174.542525 175.860870 47.958323 174.298594 175.860870 46.038494 174.021066 175.860870 44.124136 173.710024 175.860870 42.215832 173.365563 175.860870 40.314164 172.987788 175.860870 38.419711 172.576815 175.860870 36.533051 172.132768 175.860870 34.654756 171.655783 175.860870 32.785401 171.146004 175.860870 30.925554 170.603588 175.860870 29.075781 170.028700 175.860870 27.236647 169.421514 175.860870 25.408712 168.782216 175.860870 23.592531 168.111000 175.860870 21.788659 167.408071 175.860870 19.997646 166.673643 175.860870 18.220035 165.907939 175.860870 16.456370 165.111193 175.860870 14.707187 164.283648 175.860870 12.973019 163.425556 175.860870 11.254394 162.537177 175.860870 9.551837 161.618783 175.860870 7.865864 160.670654 175.860870 6.196991 159.693077 175.860870 4.545725 158.686352 175.860870 2.912569 157.650784 175.860870 1.298021 156.586689 175.860870 -0.297427 155.494392 175.860870 -1.873290 154.374224 175.860870 -3.429087 153.226528 175.860870 -4.964344 152.051652 175.860870 -6.478594 150.849955 175.860870 -7.971376 149.621802 175.860870];
% S2=[205.913043 -47.304348 64.556522 207.833958 -44.810672 64.556522 209.711060 -42.283850 64.556522 211.543776 -39.724654 64.556522 213.331549 -37.133863 64.556522 215.073835 -34.512264 64.556522 216.770101 -31.860659 64.556522 218.419833 -29.179853 64.556522 220.022527 -26.470663 64.556522 221.577695 -23.733916 64.556522 223.084863 -20.970443 64.556522 224.543572 -18.181088 64.556522 225.953378 -15.366700 64.556522 227.313852 -12.528136 64.556522 228.624578 -9.666261 64.556522 229.885159 -6.781946 64.556522 231.095209 -3.876070 64.556522 232.254360 -0.949519 64.556522 233.362260 1.996817 64.556522 234.418570 4.962039 64.556522 235.422969 7.945245 64.556522 236.375151 10.945526 64.556522 237.274825 13.961968 64.556522 238.121719 16.993651 64.556522 238.915573 20.039654 64.556522 239.656146 23.099047 64.556522 240.343213 26.170898 64.556522 240.976564 29.254273 64.556522 241.556006 32.348232 64.556522 242.081363 35.451833 64.556522 242.552475 38.564129 64.556522 242.969197 41.684173 64.556522 243.331404 44.811015 64.556522 243.638985 47.943702 64.556522 243.891847 51.081280 64.556522 244.089911 54.222794 64.556522 244.233118 57.367285 64.556522 244.321425 60.513797 64.556522 244.354803 63.661371 64.556522 244.333244 66.809048 64.556522 244.256754 69.955869 64.556522 244.125356 73.100876 64.556522 243.939090 76.243111 64.556522 243.698012 79.381616 64.556522 243.402197 82.515436 64.556522 243.051735 85.643616 64.556522 242.646731 88.765203 64.556522 242.187310 91.879247 64.556522 241.673611 94.984798 64.556522 241.105791 98.080911 64.556522 240.484023 101.166643 64.556522 239.808496 104.241053 64.556522 239.079417 107.303205 64.556522 238.297006 110.352167 64.556522 237.461503 113.387010 64.556522 236.573162 116.406809 64.556522 235.632253 119.410644 64.556522 234.639064 122.397600 64.556522 233.593896 125.366768 64.556522 232.497068 128.317243 64.556522 231.348915 131.248127 64.556522 230.149785 134.158526 64.556522 228.900044 137.047554 64.556522 227.600074 139.914331 64.556522 226.250269 142.757984 64.556522 224.851041 145.577646 64.556522 223.402816 148.372459 64.556522 221.906036 151.141572 64.556522 220.361156 153.884140 64.556522 218.768647 156.599329 64.556522 217.128994 159.286311 64.556522 215.442696 161.944268 64.556522 213.710267 164.572390 64.556522 211.932236 167.169876 64.556522 210.109142 169.735937 64.556522 208.241543 172.269789 64.556522 206.330006 174.770661 64.556522 204.375113 177.237791 64.556522 202.377462 179.670428 64.556522 200.337659 182.067830 64.556522 198.256326 184.429268 64.556522 196.134098 186.754022 64.556522 193.971620 189.041384 64.556522 191.769552 191.290657 64.556522 189.528563 193.501157 64.556522 187.249338 195.672208 64.556522 184.932570 197.803152 64.556522 182.578964 199.893337 64.556522 180.189238 201.942128 64.556522 177.764120 203.948901 64.556522 175.304348 205.913043 64.556522 172.810672 207.833958 64.556522 170.283850 209.711060 64.556522 167.724654 211.543776 64.556522 165.133863 213.331549 64.556522 162.512264 215.073835 64.556522 159.860659 216.770101 64.556522 157.179853 218.419833 64.556522 154.470663 220.022527 64.556522 151.733916 221.577695 64.556522 148.970443 223.084863 64.556522 146.181088 224.543572 64.556522 143.366700 225.953378 64.556522 140.528136 227.313852 64.556522 137.666261 228.624578 64.556522 134.781946 229.885159 64.556522 131.876070 231.095209 64.556522 128.949519 232.254360 64.556522 126.003183 233.362260 64.556522 123.037961 234.418570 64.556522 120.054755 235.422969 64.556522 117.054474 236.375151 64.556522 114.038032 237.274825 64.556522 111.006349 238.121719 64.556522 107.960346 238.915573 64.556522 104.900953 239.656146 64.556522 101.829102 240.343213 64.556522 98.745727 240.976564 64.556522 95.651768 241.556006 64.556522 92.548167 242.081363 64.556522 89.435871 242.552475 64.556522 86.315827 242.969197 64.556522 83.188985 243.331404 64.556522 80.056298 243.638985 64.556522 76.918720 243.891847 64.556522 73.777206 244.089911 64.556522 70.632715 244.233118 64.556522 67.486203 244.321425 64.556522 64.338629 244.354803 64.556522 61.190952 244.333244 64.556522 58.044131 244.256754 64.556522 54.899124 244.125356 64.556522 51.756889 243.939090 64.556522 48.618384 243.698012 64.556522 45.484564 243.402197 64.556522 42.356384 243.051735 64.556522 39.234797 242.646731 64.556522 36.120753 242.187310 64.556522 33.015202 241.673611 64.556522 29.919089 241.105791 64.556522 26.833357 240.484023 64.556522 23.758947 239.808496 64.556522 20.696795 239.079417 64.556522 17.647833 238.297006 64.556522 14.612990 237.461503 64.556522 11.593191 236.573162 64.556522 8.589356 235.632253 64.556522 5.602400 234.639064 64.556522 2.633232 233.593896 64.556522 -0.317243 232.497068 64.556522 -3.248127 231.348915 64.556522 -6.158526 230.149785 64.556522 -9.047554 228.900044 64.556522 -11.914331 227.600074 64.556522 -14.757984 226.250269 64.556522 -17.577646 224.851041 64.556522 -20.372459 223.402816 64.556522 -23.141572 221.906036 64.556522 -25.884140 220.361156 64.556522 -28.599329 218.768647 64.556522 -31.286311 217.128994 64.556522 -33.944268 215.442696 64.556522 -36.572390 213.710267 64.556522 -39.169876 211.932236 64.556522 -41.735937 210.109142 64.556522 -44.269789 208.241543 64.556522 -46.770661 206.330006 64.556522 -49.237791 204.375113 64.556522 -51.670428 202.377462 64.556522 -54.067830 200.337659 64.556522 -56.429268 198.256326 64.556522 -58.754022 196.134098 64.556522 -61.041384 193.971620 64.556522 -63.290657 191.769552 64.556522 -65.501157 189.528563 64.556522 -67.672208 187.249338 64.556522 -69.803152 184.932570 64.556522 -71.893337 182.578964 64.556522 -73.942128 180.189238 64.556522 -75.948901 177.764120 64.556522 -77.913043 175.304348 64.556522 -79.833958 172.810672 64.556522 -81.711060 170.283850 64.556522 -83.543776 167.724654 64.556522 -85.331549 165.133863 64.556522 -87.073835 162.512264 64.556522 -88.770101 159.860659 64.556522 -90.419833 157.179853 64.556522 -92.022527 154.470663 64.556522 -93.577695 151.733916 64.556522 -95.084863 148.970443 64.556522 -96.543572 146.181088 64.556522 -97.953378 143.366700 64.556522 -99.313852 140.528136 64.556522 -100.624578 137.666261 64.556522 -101.885159 134.781946 64.556522 -103.095209 131.876070 64.556522 -104.254360 128.949519 64.556522 -105.362260 126.003183 64.556522 -106.418570 123.037961 64.556522 -107.422969 120.054755 64.556522 -108.375151 117.054474 64.556522 -109.274825 114.038032 64.556522 -110.121719 111.006349 64.556522 -110.915573 107.960346 64.556522 -111.656146 104.900953 64.556522 -112.343213 101.829102 64.556522 -112.976564 98.745727 64.556522 -113.556006 95.651768 64.556522 -114.081363 92.548167 64.556522 -114.552475 89.435871 64.556522 -114.969197 86.315827 64.556522 -115.331404 83.188985 64.556522 -115.638985 80.056298 64.556522 -115.891847 76.918720 64.556522 -116.089911 73.777206 64.556522 -116.233118 70.632715 64.556522 -116.321425 67.486203 64.556522 -116.354803 64.338629 64.556522 -116.333244 61.190952 64.556522 -116.256754 58.044131 64.556522];
% 
% S=reshape(S,3,221);
% S2=reshape(S2,3,221);
% 
% plot3(S(1,:),S(2,:),S(3,:));
% grid on;axis equal;hold on; plot3(64,64,64,'ro')
% plot3(S2(1,:),S2(2,:),S2(3,:),'g');
%%

